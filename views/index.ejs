<div class="voting-container">
    <h1>Hvilken rev er s√∏test? ü¶ä</h1>
    <p class="subtitle">Klikk p√• bildet av reven du synes er s√∏test!</p>

    <div id="voting-section" class="voting-section">
        <div class="loading">Laster rever...</div>
    </div>

    <div id="result-message" class="result-message" style="display: none;"></div>

    <% if (trendingFoxes && trendingFoxes.length > 0) { %>
    <section class="trending-section">
        <h2>üî• Dagens trending rever</h2>
        <div class="trending-grid">
            <% trendingFoxes.forEach(fox => { %>
            <div class="trending-fox">
                <img src="<%= fox.imageUrl %>" alt="Fox <%= fox.foxNumber %>" loading="lazy" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkJpbGRlIGlra2UgZnVubmV0PC90ZXh0Pjwvc3ZnPg=='">
                <div class="trending-info">
                    <span class="fox-number">Rev #<%= fox.foxNumber %></span>
                    <span class="vote-count"><%= fox.totalVotes %> stemmer</span>
                </div>
            </div>
            <% }) %>
        </div>
    </section>
    <% } %>
</div>

<div id="toast-container"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadRandomFoxes();
});

async function loadRandomFoxes() {
    try {
        console.log('Loading random foxes...');
        const response = await fetch('/vote/random-foxes');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Loaded foxes:', data);
        
        displayFoxes(data.fox1, data.fox2);
    } catch (error) {
        console.error('Error loading foxes:', error);
        document.getElementById('voting-section').innerHTML = 
            '<div class="error">Kunne ikke laste rever. Pr√∏v igjen senere.<br><button onclick="loadRandomFoxes()" class="btn btn-primary" style="margin-top: 1rem;">Pr√∏v igjen</button></div>';
    }
}

function displayFoxes(fox1, fox2) {
    const votingSection = document.getElementById('voting-section');
    
    votingSection.innerHTML = `
        <div class="fox-comparison">
            <div class="fox-option" onclick="vote(${fox1.number})">
                <img src="${fox1.url}" alt="Fox ${fox1.number}" loading="lazy" 
                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1zbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkJpbGRlIGlra2UgZnVubmV0PC90ZXh0Pjwvc3ZnPg=='">
                <button class="vote-btn">Velg denne reven</button>
                <span class="fox-label">Rev #${fox1.number}</span>
            </div>
            <div class="vs-divider">VS</div>
            <div class="fox-option" onclick="vote(${fox2.number})">
                <img src="${fox2.url}" alt="Fox ${fox2.number}" loading="lazy"
                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1zbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkJpbGRlIGlra2UgZnVubmV0PC90ZXh0Pjwvc3ZnPg=='">
                <button class="vote-btn">Velg denne reven</button>
                <span class="fox-label">Rev #${fox2.number}</span>
            </div>
        </div>
    `;
}

async function vote(foxNumber) {
    try {
        const response = await fetch(`/vote/vote/${foxNumber}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast(`${result.message} (${result.totalVotes} totale stemmer)`, 'success');
            
            // Show result and load new foxes after delay
            setTimeout(() => {
                loadRandomFoxes();
            }, 2000);
        } else {
            showToast(result.error || 'Kunne ikke registrere stemme', 'error');
        }
    } catch (error) {
        console.error('Voting error:', error);
        showToast('Nettverksfeil. Pr√∏v igjen senere.', 'error');
    }
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    
    document.getElementById('toast-container').appendChild(toast);
    
    // Trigger animation
    setTimeout(() => toast.classList.add('show'), 100);
    
    // Remove after 4 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}

// Socket.io for real-time updates
const socket = io();
socket.on('voteUpdate', function(data) {
    console.log('Vote update:', data);
});
</script>
